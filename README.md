# rucio-dirac-dev

Basic test setup of rucio and dirac using docker compose.

This is material prepared from the on-going work at CTAO to
use DIRAC with Rucio for the Rucio-DIRAC 2025-01 workshop at CERN.


The setup here consists of a simplified Rucio and DIRAC setup,
running in docker compose on a single machine.

It could be expanded during the workshop to allow local
development (i.e. running the components based on local sources).

## Setup

This setup relies on the:

* docker compose
* Upstream Rucio docker images
* Upstream DIRACOS
* Upstream DIRAC PyPI packages
* A self-signed certificate chain, committed into the repository 
  for convenience but fully automatically generated by `./certs/generate_certificates.sh`

Since the setup requires executing commands in the started docker containers
in particular orders that cannot really be performed by entry points,
a python script performing these steps is provided.

If you want to develop rucio and/or DIRAC, you need to export two environment variables
pointing to the rucio and DIRAC repositories respectively:

```
$ export DIRAC_REPOSITORY=/abs/path/to/your/DIRAC
$ export RUCIO_REPOSITORY=/abs/path/to/your/rucio
```

The repositories will be mounted into the relevant containers and installed in editable mode.

To spin up all components, run
```
[host] $ python3 dev_setup.py setup`
```

The containers are build to run using your local user / group IDs
to prevent issues with file permissions / ownership.
If you interact manually with docker compose, please run before:
```
[host] $ source env.sh
```

Then you can run commands without getting warnings about undefined `USERID`/`GROUPID`, e.g.:
```
[host] $ docker compose ps
```


For a clean start (removing everything including data), run
```
[host] $ python3 dev_setup.py teardown
```


## Tests

A couple of pytest-based tests are defined in `tests/`, which must be executed in the `clients`
container.

```
[host   ] $ docker compose exec clients bash
[clients] $ python3 -m pytest tests -v
```

The tests include adding/downloading data to/from rucio, 
submitting a simple job on DIRAC and then the interactions
that require the correct setup of the `RucioFileCatalog` in DIRAC:
Accessing data stored in Rucio via DIRAC and submitting jobs
that load/store input/output there.
